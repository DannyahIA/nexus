# Docker Compose Otimizado para Desenvolvimento e Produção
# Versão com health checks, resource limits, e configurações de segurança

services:
  # Base de dados Cassandra com configurações otimizadas
  cassandra:
    image: cassandra:4.1
    container_name: nexus-cassandra
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=Nexus
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - MAX_HEAP_SIZE=2G
      - HEAP_NEWSIZE=200M
    volumes:
      - cassandra_data:/var/lib/cassandra
      - ./infrastructure/cassandra/cassandra.yaml:/etc/cassandra/cassandra.yaml:ro
    networks:
      - nexus-network
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe cluster"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # Inicialização do Cassandra com retry automático
  cassandra-init:
    image: cassandra:4.1
    container_name: nexus-cassandra-init
    depends_on:
      cassandra:
        condition: service_healthy
    volumes:
      - ./infrastructure/cassandra:/migrations:ro
    networks:
      - nexus-network
    command: >
      sh -c "
        echo 'Aguardando Cassandra estar pronto...' &&
        sleep 30 &&
        echo 'Executando migrações...' &&
        for f in /migrations/*.cql; do
          echo \"Aplicando $$f\" &&
          cqlsh cassandra -f \"$$f\" --request-timeout=60 ||
          (echo \"Tentativa 1 falhou, tentando novamente em 10s...\" && sleep 10 && cqlsh cassandra -f \"$$f\" --request-timeout=60) ||
          (echo \"Tentativa 2 falhou, tentando novamente em 20s...\" && sleep 20 && cqlsh cassandra -f \"$$f\" --request-timeout=60) ||
          echo \"Falha permanente em $$f\"
        done &&
        echo 'Migrações concluídas!'
      "
    restart: "no"

  # NATS JetStream com configurações de produção
  nats:
    image: nats:2.10-alpine
    container_name: nexus-nats
    ports:
      - "4222:4222"
      - "6222:6222"
      - "8222:8222"
    command: >
      -js -sd /data 
      --cluster_name nexus-cluster
      --max_payload 8MB
      --max_connections 1000
      --write_deadline 10s
      --max_control_line 2KB
    volumes:
      - nats_data:/data
      - ./infrastructure/nats/nats.conf:/etc/nats/nats.conf:ro
    networks:
      - nexus-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # TURN server para WebRTC
  coturn:
    image: coturn/coturn:latest
    container_name: nexus-turn
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "5349:5349/tcp"
      - "5349:5349/udp"
      - "49152-49252:49152-49252/udp"  # Range para TURN relay
    volumes:
      - ./infrastructure/turn/turnserver.conf:/etc/coturn/turnserver.conf:ro
    environment:
      - TURNSERVER_ENABLED=1
      - DETECT_RELAY_IP=yes
    networks:
      - nexus-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "2"

  # Redis com configurações de produção
  redis:
    image: redis:7-alpine
    container_name: nexus-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./infrastructure/redis/redis.conf:/etc/redis/redis.conf:ro
    command: redis-server /etc/redis/redis.conf
    networks:
      - nexus-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "2"

  # API Service otimizado com multi-stage build
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: api
      args:
        BUILD_VERSION: ${BUILD_VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
    image: nexus/api:${BUILD_VERSION:-dev}
    container_name: nexus-api
    ports:
      - "8000:8000"
    environment:
      - CASS_HOSTS=cassandra
      - CASS_KEYSPACE=nexus
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis:6379
      - JWT_SECRET=${JWT_SECRET:-change-in-production}
      - ENV=production
      - LOG_LEVEL=info
      - API_PORT=8000
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
    volumes:
      - api_uploads:/app/uploads
    networks:
      - nexus-network
    depends_on:
      cassandra:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # WebSocket Service otimizado
  websocket:
    build:
      context: ./backend
      dockerfile: Dockerfile  
      target: websocket
      args:
        BUILD_VERSION: ${BUILD_VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
    image: nexus/websocket:${BUILD_VERSION:-dev}
    container_name: nexus-websocket
    ports:
      - "8080:8080"
    environment:
      - CASS_HOSTS=cassandra
      - CASS_KEYSPACE=nexus
      - NATS_URL=nats://nats:4222
      - REDIS_URL=redis:6379
      - JWT_SECRET=${JWT_SECRET:-change-in-production}
      - ENV=production
      - LOG_LEVEL=info
      - WS_PORT=8080
    networks:
      - nexus-network
    depends_on:
      cassandra:
        condition: service_healthy
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # Media Service otimizado
  media:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: media
      args:
        BUILD_VERSION: ${BUILD_VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME}
        GIT_COMMIT: ${GIT_COMMIT}
    image: nexus/media:${BUILD_VERSION:-dev}
    container_name: nexus-media
    ports:
      - "8081:8081"
    environment:
      - ENV=production
      - LOG_LEVEL=info
    networks:
      - nexus-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

# Volumes persistentes com drivers otimizados
volumes:
  cassandra_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/cassandra
  nats_data:
    driver: local
    driver_opts:
      type: none
      o: bind  
      device: ${DATA_PATH:-./data}/nats
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/redis
  api_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/uploads

# Network otimizada para comunicação entre serviços
networks:
  nexus-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: br-nexus
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
